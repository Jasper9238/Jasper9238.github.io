<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Post Detail - Loading...</title>
    
    <style>
        /* --- General and Base Styles --- */
        body { font-family: Arial, sans-serif; padding: 20px; }
        h1, h2, h3 { color: #333; }
        
        /* Note Styling (for the main post) */
        .note { 
            border: 1px solid #ddd; 
            padding: 15px; 
            margin-bottom: 25px; 
            border-radius: 8px; 
            background-color: #f9f9f9;
        }
        .note-title { 
            font-weight: bold; 
            font-size: 1.5em; 
            color: #2196F3;
            margin-bottom: 5px;
        }
        .submit-btn {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        /* Style for Comments */
        .comment-box { 
            border: 1px solid #eee; 
            padding: 10px; 
            margin-bottom: 10px;
            border-radius: 6px; 
            background: #fcfcfc;
        }
        .comment-author {
            font-size: 0.8em;
            color: #777;
            margin-top: 5px;
            display: block;
        }
        #likeBtn, #dislikeBtn {
            padding: 8px 12px;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            cursor: pointer;
            margin-right: 5px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        
        .active-reaction {
            background-color: #007bff; /* Blue for active */
            color: white;
            border-color: #007bff;
        }
    </style>
</head>
<body>
    <header>
        <h1><a href="/grade-9/science/index.html">‚Üê Back to Posts</a></h1>
    </header>

    <hr>
    <div id="loading-status">Loading post...</div>

    <div id="main-post-container" class="note" style="display:none;">
        </div>

    <div id="reaction-counts">
        <span id="like-count">0</span>
        <span id="dislike-count">0</span>
    </div>
    <button id="likeBtn" data-reaction-type="like">üëç Like</button>
    <button id="dislikeBtn" data-reaction-type="dislike">üëé Dislike</button>
    <div id="reply-form-container" style="margin-top: 20px; display:none;">
        <h3>Leave a Comment</h3>
        <textarea id="replyContent" placeholder="Type your reply here..." rows="3" style="width: 100%; padding: 8px;"></textarea>
        <button id="submitReplyBtn" class="submit-btn">Post Reply</button>
    </div>

    <hr>

    <h3>Replies (<span id="replyCount">0</span>)</h3>
    <div id="comments-container">
        </div>

    <script type="module" src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js"></script>
    <script type="module" src="/js/firebaseAuth.js"></script> 
    
    <script type="module">
    import { 
        subscribeToAuthChanges, 
        getCurrentUserToken 
    } from '/js/firebaseAuth.js'; 

    // --- CONFIG ---
    const BACKEND_URL = "https://studyhub-backend-iy1e.onrender.com";
    const urlParams = new URLSearchParams(window.location.search);
    const postId = urlParams.get('id'); 
    let currentUser = null; 

    // --- NEW GLOBAL STATE ---
    let currentUserReaction = 'null'; // 'like', 'dislike', or 'null'

    // --- UI ELEMENTS ---
    const mainPostContainer = document.getElementById('main-post-container');
    const commentsContainer = document.getElementById('comments-container');
    const replyFormContainer = document.getElementById('reply-form-container');
    const replyContentArea = document.getElementById('replyContent');
    const submitReplyBtn = document.getElementById('submitReplyBtn');
    
    // UI Elements
    const likeBtn = document.getElementById('likeBtn');
    const dislikeBtn = document.getElementById('dislikeBtn');
    
    // --- AUTH & UI STATE ---
    subscribeToAuthChanges(async (user) => { // Made async to run reaction state fetch
        currentUser = user; 
        replyFormContainer.style.display = user ? 'block' : 'none';
        
        //  Fetch user's reaction state immediately on login/logout
        if (postId) {
             await fetchUserReactionState(postId);
        }
    });

    // --- A. DATA FETCHING (MODIFIED) ---
    async function fetchPostDetail() {
        if (!postId) {
            document.getElementById('loading-status').textContent = 'Error: No Post ID provided.';
            return;
        }

        document.getElementById('loading-status').textContent = 'Loading...';
        
        try {
            const response = await fetch(`${BACKEND_URL}/get_note/${postId}`);
            
            if (response.status === 404) {
                document.getElementById('loading-status').textContent = 'Post not found.';
                return;
            }
            if (!response.ok) throw new Error(`Server Error: ${response.status}`);
            
            const postData = await response.json();
            
            document.getElementById('loading-status').style.display = 'none';
            mainPostContainer.style.display = 'block';

            renderMainPost(postData);
            renderComments(postData.comments);
            
            // Render the total reaction counts received from the combined API
            if (postData.reactions) {
                renderReactionCounts(postData.reactions);
            }

            // Fetch user state separately as it requires the token
            if (currentUser) {
                await fetchUserReactionState(postId);
            } else {
                // Reset state and styles if logged out
                currentUserReaction = 'null';
                updateButtonStyles();
            }

        } catch (error) {
            document.getElementById('loading-status').textContent = `Error loading post: ${error.message}`;
            console.error(error);
        }
    }
    
    // Function to fetch the user's specific state
    async function fetchUserReactionState(postId) {
        const idToken = await getCurrentUserToken(false); 
        if (!idToken) return;

        try {
            const response = await fetch(`${BACKEND_URL}/get_user_reaction/${postId}`, {
                headers: {
                    "Authorization": `Bearer ${idToken}`
                }
            });
            
            const data = await response.json();
            
            // Update global state
            currentUserReaction = data.userReaction; // 'like', 'dislike', or 'null'
            updateButtonStyles(); 

        } catch (e) {
            console.error("Could not fetch user reaction state:", e);
        }
    }


    // --- B. RENDERING FUNCTIONS (MODIFIED) ---
    function renderMainPost(note) {
        // ... (Your existing renderMainPost logic remains here) ...
        const categoryText = note.category || 'Note';
        let badgeStyle = '';
        switch (categoryText.toLowerCase()) {
            case 'question': badgeStyle = 'background-color: #ffc107; color: #343a40;'; break;
            case 'solution': badgeStyle = 'background-color: #28a745; color: white;'; break;
            default: badgeStyle = 'background-color: #007bff; color: white;';
        }
        
        const authorDisplay = note.authorId ? `User ID: ${note.authorId.substring(0, 6)}...` : 'Unknown';
        document.getElementById('pageTitle').textContent = note.title;

        //  Simple string conversion
        const dateString = note.dateCreated ? new Date(note.dateCreated).toLocaleDateString() : 'Date Unknown';

        mainPostContainer.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px;">
                <div class="note-title" style="margin: 0; color: #333;">${note.title}</div>
                <span style="${badgeStyle} font-size: 0.8em; padding: 3px 8px; border-radius: 12px; font-weight: bold; white-space: nowrap; margin-left: 10px;">
                    ${categoryText.toUpperCase()}
                </span> 
            </div>
            <div class="note-author" style="margin-bottom: 10px;">By: ${authorDisplay}</div>
            <div class="note-content">${note.content}</div>
            <hr style="border-top: 1px solid #ddd; margin-top: 15px;">
            <small style="color:#999;">Posted: ${dateString}</small>
        `;
    }

    function renderComments(comments) {
        // ... (Your existing renderComments logic remains here) ...
        document.getElementById('replyCount').textContent = comments.length;
        commentsContainer.innerHTML = '';

        if (comments.length === 0) {
            commentsContainer.innerHTML = '<p>No replies yet. Be the first!</p>';
            return;
        }
        
        comments.forEach(comment => {
            const div = document.createElement('div');
            div.className = 'comment-box';
            
            const commentAuthor = comment.authorId ? `User ID: ${comment.authorId.substring(0, 6)}...` : 'Unknown';
            
            // Simple string conversion
            let dateDisplay = "";
            try {
                 const d = new Date(comment.dateCreated);
                 dateDisplay = `${d.toLocaleTimeString()} - ${d.toLocaleDateString()}`;
            } catch (e) {
                 dateDisplay = "Date Unknown";
            }

            div.innerHTML = `
                <p style="margin-bottom: 5px;">${comment.content}</p>
                <span class="comment-author">
                    By ${commentAuthor} (${dateDisplay})
                </span>
            `;
            commentsContainer.appendChild(div);
        });
    }
    
    // üö® NEW: Function to render the total counts
    function renderReactionCounts(counts) {
        const likeCountEl = document.getElementById('like-count');
        const dislikeCountEl = document.getElementById('dislike-count');

        if (likeCountEl) likeCountEl.textContent = counts.likeCount;
        if (dislikeCountEl) dislikeCountEl.textContent = counts.dislikeCount;
    }
    
    // üö® NEW: Function to toggle the button style
    function updateButtonStyles() {
        if (!likeBtn || !dislikeBtn) return;

        // Reset all active classes first
        likeBtn.classList.remove('active-reaction');
        dislikeBtn.classList.remove('active-reaction');

        if (currentUserReaction === 'like') {
            likeBtn.classList.add('active-reaction');
        } else if (currentUserReaction === 'dislike') {
            dislikeBtn.classList.add('active-reaction');
        }
    }


    // --- C. REPLY SUBMISSION LOGIC (UNCHANGED) ---
    submitReplyBtn.addEventListener("click", async () => {
        if (!currentUser) {
            alert("Please sign in to post a reply.");
            return;
        }
        const content = replyContentArea.value.trim();
        if (!content) {
            alert("Reply content cannot be empty.");
            return;
        }
        
        submitReplyBtn.disabled = true;
        const idToken = await getCurrentUserToken(true); 

        try {
            const data = { postId, content }; 
            const res = await fetch(`${BACKEND_URL}/add_comment`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${idToken}` 
                },
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                replyContentArea.value = "";
                // üö® Refreshes counts/comments/etc.
                await fetchPostDetail(); 
            } else {
                const errorResult = await res.json();
                alert(`Failed to post reply: ${errorResult.message || res.statusText}`);
            }
        } catch (e) {
            alert("An error occurred while posting.");
            console.error(e);
        } finally {
            submitReplyBtn.disabled = false;
        }
    });

    // --- D. REACTION SUBMISSION LOGIC  ---
    async function handleReactionClick(event) {
        if (!currentUser) {
            alert("Please log in to react to a post.");
            return;
        }
        
        const reactionType = event.currentTarget.dataset.reactionType; // 'like' or 'dislike'
        const idToken = await getCurrentUserToken(true); // Get a fresh token

        // Temporarily disable buttons for visual feedback
        likeBtn.disabled = true;
        dislikeBtn.disabled = true;

        try {
            const response = await fetch(`${BACKEND_URL}/react`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${idToken}`
                },
                body: JSON.stringify({
                    postId: postId,
                    type: reactionType
                })
            });

            if (!response.ok) throw new Error("Reaction failed.");

            // On success, re-fetch data to update counts and button state
            await fetchPostDetail(); 

        } catch (error) {
            console.error("Failed to submit reaction:", error);
        } finally {
            // Re-enable buttons
            likeBtn.disabled = false;
            dislikeBtn.disabled = false;
        }
    }

    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', () => {
        if (likeBtn) likeBtn.addEventListener('click', handleReactionClick);
        if (dislikeBtn) dislikeBtn.addEventListener('click', handleReactionClick);
        
        fetchPostDetail();
    });

</script>