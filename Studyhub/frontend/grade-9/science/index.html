<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade 9 Science Questions&Notes</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        h1, h2 { color: #333; }
        
        .note { 
            border: 1px solid #ddd; 
            padding: 15px; 
            margin-bottom: 15px; 
            border-radius: 8px; 
            background-color: #f9f9f9;
        }
        .note-title { 
            font-weight: bold; 
            font-size: 1.3em; 
            color: #2196F3;
            margin-bottom: 5px;
        }
        .note-author { 
            font-style: italic; 
            color: #777; 
            font-size: 0.9em;
            margin-bottom: 10px;
            display: block;
        }
        .post-btn {
            background: #4CAF50;
            color: white;
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 20px;
            transition: background 0.3s;
        }
        .post-btn:hover {
            background: #45a049;
        }

        /* Popup modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            /* Use flex to center the content */
            display: flex; 
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .modal-content input,
        .modal-content textarea {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }
        .modal-content textarea {
            resize: vertical;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end; /* Align buttons to the right */
            gap: 10px;
            margin-top: 20px;
        }

        .submit-btn {
            background: #2196F3;
            color: white;
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .submit-btn:hover {
            background: #1e87e5;
        }

        .cancel-btn {
            background: #777;
            color: white;
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .cancel-btn:hover {
            background: #666;
        }
        
        #login-form input {
            width: 95%;
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        #login-form button {
            padding: 10px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        #sign-out-btn {
            background: #dc3545;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }
        #sign-out-btn:hover {
            background: #c82333;
        }
        
    </style>
</head>
<body>
    <h1>Grade 9 Science Q&A / Notes</h1>
    
    <div id="auth-ui">
        <p id="auth-status">Loading user status...</p>
        
        <form id="login-form" style="display: none; border: 1px solid #ddd; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
            <h3>User Sign In / Sign Up</h3>
            <input type="email" id="auth-email" placeholder="Email" required>
            <input type="password" id="auth-password" placeholder="Password" required>
            <button type="submit" id="sign-in-btn">Sign In / Sign Up</button>
        </form>
        
        <button id="sign-out-btn" style="display: none;">Sign Out</button>
    </div>
    
    <hr>
    
    <button id="postNoteBtn" class="post-btn" style="display: none;">Post Note</button>

    <div id="noteModal" class="modal" style="display: none;"> 
    <div class="modal-content">
        <h2>Post a Note</h2>
        <select id="postCategory" required style="width: 100%; padding: 10px; margin: 10px 0; border-radius: 6px; border: 1px solid #ccc;">
            <option value="">-- Select Post Type --</option>
            <option value="note">Study Note</option>
            <option value="question">Question</option>
            <option value="solution">Solution/Answer</option>
        </select>
        <input id="noteTitle" type="text" placeholder="Title" required>
        <textarea id="noteContent" placeholder="Write your note here..." required></textarea>
        
        <div class="modal-actions">
        <button id="closeModal" class="cancel-btn">Cancel</button>
        <button id="submitNote" class="submit-btn">Submit</button>
        </div>
    </div>
    </div>

    <hr>

    <h2>Community Questions & Notes</h2>
    <div id="notes-container">Loading posts...</div>

    <script type="module" src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js"></script>

    <script type="module" src="/js/firebaseAuth.js"></script> 

    <script type="module">
        
        // This import uses the CORRECT RELATIVE path to access the module 
        // two levels up (../../) and then into the js folder.
        import { 
            signIn, 
            signUp, 
            userSignOut, 
            subscribeToAuthChanges, 
            getCurrentUserToken 
        } from '../../js/firebaseAuth.js'; 
        
        // --- PAGE-SPECIFIC GLOBAL VARIABLES ---
        const GRADE = '9';
        const SUBJECT = 'science';
        let currentUser = null; // Variable to hold the current user object
        
        // --- AUTH UI ELEMENTS ---
        const authStatus = document.getElementById('auth-status');
        const loginForm = document.getElementById('login-form');
        const emailInput = document.getElementById('auth-email');
        const passwordInput = document.getElementById('auth-password');
        const signOutButton = document.getElementById('sign-out-btn');
        const postNoteBtn = document.getElementById('postNoteBtn');

        // --- NOTE MODAL UI ELEMENTS ---
        const modal = document.getElementById("noteModal");
        const closeModalBtn = document.getElementById("closeModal");
        const submitNoteBtn = document.getElementById("submitNote");
        const noteTitleInput = document.getElementById("noteTitle");
        const noteContentInput = document.getElementById("noteContent");
        
        const notesContainer = document.getElementById('notes-container');


        // --- A. AUTHENTICATION STATE HANDLER ---
        subscribeToAuthChanges((user) => {
        currentUser = user; 
        
        if (user) {
            authStatus.textContent = `Welcome, ${user.email}!`;
            loginForm.style.display = 'none';
            signOutButton.style.display = 'block';
            postNoteBtn.style.display = 'block';
        } else {
            authStatus.textContent = "Please sign in to post.";
            loginForm.style.display = 'block';
            signOutButton.style.display = 'none';
            postNoteBtn.style.display = 'none';
        }
    });


    // --- B. AUTHENTICATION LOGIC (Correct) ---
    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const email = emailInput.value;
        const password = passwordInput.value;

        signIn(email, password)
            .catch(() => {
                return signUp(email, password)
                    .catch(error => {
                        alert(`Authentication Error: ${error.message}`);
                    });
            });
    });

    signOutButton.addEventListener('click', () => {
        userSignOut();
    });




        // --- C. NOTE POSTING LOGIC (UPDATED WITH TOKEN!) ---

        postNoteBtn.addEventListener("click", () => {
        if (currentUser) {
            modal.style.display = "flex"; 
        } else {
            alert("You must be signed in to post a note.");
        }
    });

    closeModalBtn.addEventListener("click", () => {
        modal.style.display = "none";
    });

    submitNoteBtn.addEventListener("click", async () => {
        const title = noteTitleInput.value;
        const content = noteContentInput.value;

        if (!title || !content) {
            alert("Please fill in both fields.");
            return;
        }
        
        const idToken = await getCurrentUserToken(true); 

        if (!idToken) {
            alert("Error: User token not found. Please sign in again.");
            return;
        }
        
        const category = document.getElementById("postCategory").value; 

        if (!category) {
            alert("Please select a post type.");
            return;
        }
        
        const data = { 
            grade: GRADE, 
            subject: SUBJECT, 
            category: category, 
            title, 
            content,
        };

        const res = await fetch("https://studyhub-backend-iy1e.onrender.com/add_note", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${idToken}` 
            },
            body: JSON.stringify(data)
        });
        
        modal.style.display = "none";
        noteTitleInput.value = "";
        noteContentInput.value = "";

        if (res.ok) {
            fetchNotes();
            alert("Posted successfully!");
        } else {
            const errorResult = await res.json();
            alert(`Failed to post: ${errorResult.message || res.statusText}`);
        }
    });

async function fetchNotes() { 
        const url = `https://studyhub-backend-iy1e.onrender.com/get_notes?grade=${GRADE}&subject=${SUBJECT}`;
        
        try {
            const response = await fetch(url);
            const notes = await response.json();

            notesContainer.innerHTML = '';

            if (!Array.isArray(notes) || notes.length === 0) {
                notesContainer.innerHTML = '<p>No posts found yet. Be the first to post!</p>';
                return;
            }

            notes.forEach(note => {
                const categoryText = note.category || 'Note';
                let badgeStyle = '';
                
                switch (categoryText.toLowerCase()) {
                    // ... (Case logic for badgeStyle as before) ...
                    case 'question':
                        badgeStyle = 'background-color: #ffc107; color: #343a40;';
                        break;
                    case 'solution':
                        badgeStyle = 'background-color: #28a745; color: white;';
                        break;
                    case 'note':
                    default:
                        badgeStyle = 'background-color: #007bff; color: white;';
                }
                
                const authorDisplay = note.authorId ? `User ID: ${note.authorId.substring(0, 6)}...` : 'Unknown';
                
                const noteTitleHTML = `
                    <a href="../../../note-detail.html?id=${note.id}" 
                       style="text-decoration: none; color: inherit;">
                        ${note.title}
                    </a>`;
                
                const div = document.createElement('div');
                div.className = 'note';
                
                // --- FULL, STYLED STRUCTURE WITH LINK ---
                div.innerHTML = `
                    
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px;">
                        <div class="note-title" style="margin: 0;">${noteTitleHTML}</div>
                        <span class="note-type-badge" style="
                            ${badgeStyle}
                            font-size: 0.8em;
                            padding: 3px 8px;
                            border-radius: 12px;
                            font-weight: bold;
                            white-space: nowrap;
                            margin-left: 10px;
                        ">${categoryText.toUpperCase()}</span> 
                    </div>
                    <div class="note-author">By: ${authorDisplay}</div>
                    <div class="note-content">${note.content}</div>
                `;
                notesContainer.appendChild(div);
            });
        } catch (error) {
            console.error("Error fetching posts:", error);
            notesContainer.innerHTML = '<p>Error fetching posts.</p>';
        }
    }

        fetchNotes(); // Initial load
    </script>
</body>
</html>